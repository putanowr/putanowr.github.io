
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Adding new meshing domains &#8212; Nadamak 0.1 documentation</title>
    <link rel="stylesheet" href="../../../static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="prev" title="Extending Nadamak" href="../development.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../mat-modindex.html" title="MATLAB Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../development.html" title="Extending Nadamak"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Nadamak 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../development.html" accesskey="U">Extending Nadamak</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="adding-new-meshing-domains">
<span id="newgeodomain-sec"></span><h1>Adding new meshing domains<a class="headerlink" href="#adding-new-meshing-domains" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>As explained in chapter FIXME Nadamak provides meshing capabilities interfacing
GMSH via data files produced from pre-defined templates. The template files
describe parameterized geometric models. When mesh is generated the
parameters are substituted in Matlab producing input files for GMSH. The
generated mesh is read back from mesh file and presented to user as a Mesh
object.</p>
<p>The whole machinery of templates handling and calling GMSH is hidden behind
convenient object oriented interface described in section FIXME. Here we take a
closer look at this machinery by following a step by step explanation how a new
geometric model can be added to Nadamak. The steps involve:</p>
<ul class="simple">
<li>Creation of non-templatized geometric model for GMSH.</li>
<li>Implementation of a class derived from mp.Geom to wrap the geometric model.</li>
<li>Templatization of GMSH input file and linking it with Matlab class.</li>
<li>Introduction of more advanced features as subdomain and meshing control variables.</li>
</ul>
<p>These steps will be illustrated in details on the example of geometric model of
a quarter of notched rectangle domain shown in <a class="reference internal" href="#fig-nrq-domain"><span class="std std-numref">Fig. 1</span></a>.</p>
<div class="figure" id="id3">
<span id="fig-nrq-domain"></span><img alt="../../../images/notchedrectquarter.png" src="../../../images/notchedrectquarter.png" />
<p class="caption"><span class="caption-number">Fig. 1 </span><span class="caption-text">Geometric domain of a quarter of notched rectangle.</span></p>
</div>
<div class="section" id="creating-gmsh-geometry-input-file">
<h2>Creating GMSH geometry input file<a class="headerlink" href="#creating-gmsh-geometry-input-file" title="Permalink to this headline">¶</a></h2>
<p>The starting point in adding new meshing domain is to prepare a valid GMSH geometry
file describing the desired geometry. This file will will be then turned into template
file processed by Matlab, but first one has to make sure that there is no error in
geometry definition and GMSH is able to produce a mesh from this file.</p>
<p>To complete this step some knowledge of GMSH scripting language is required. In GMSH
geometries are described using boundary representation (B-Rep). The model is built
by successively defining primitives of increased complexity and dimension, starting
from points, curves, surface and volumes.</p>
<p>When looking at <a class="reference internal" href="#fig-nrq-domain"><span class="std std-numref">Fig. 1</span></a> we can see that it is parameterised by
three parameters <span class="math notranslate nohighlight">\(W,H\)</span> and <span class="math notranslate nohighlight">\(R\)</span>. It is advantageous to introduce these
parameters right from the start in the GMSH geometry file, for the moment giving them
some fixed value. When creating B-Rep representation of our geometry we should already
envisage how it should be decomposed into geometric elements in order to make convenient
application of attributes such as boundary conditions, loads or material properties.
Having this in mind the arc is split into two pieces by a point <span class="math notranslate nohighlight">\((x_a, y_a)\)</span>.
To make this splitting flexible we introduce additional parameter
<span class="math notranslate nohighlight">\(t \in [0, 1]\)</span> that describes the position
of the point on arc via formula</p>
<div class="math notranslate nohighlight">
\begin{align}
   x_a   &amp;= W - R \cos(t \frac{\pi}{2} )\\
   y_a   &amp;= R \sin(t \frac{\pi}{2})
\end{align}</div><p>The complete GMSH input file is shown in listing <a class="reference internal" href="#lst-notchedrectquarter"><span class="std std-numref">Listing 1</span></a>.
Additional parameter <span class="math notranslate nohighlight">\(lc\)</span>, defined in the first line, is the desired edge
length of the generated mesh in the neighbourhood of the given point.</p>
<p><strong>IMPORTANT</strong> The interface to GMSH implemented in Nadamak assumes that in the
generated mesh at least one physical region is present. Thus, while it is not strictly
necessary for running GMSH, in the last line in <a class="reference internal" href="#lst-notchedrectquarter"><span class="std std-numref">Listing 1</span></a>
a region with name <code class="docutils literal notranslate"><span class="pre">d_whole</span></code> is defined. The names assigned to regions are arbitrary
as long as they can be used as Matlab variable names.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<span id="lst-notchedrectquarter"></span><div class="code-block-caption"><span class="caption-number">Listing 1 </span><span class="caption-text">GMSH geometry input file for domain in <a class="reference internal" href="#fig-nrq-domain"><span class="std std-numref">Fig. 1</span></a></span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lc</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="n">R</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">W</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">H</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">t</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="n">xa</span> <span class="o">=</span> <span class="n">W</span><span class="o">-</span><span class="n">R</span><span class="o">*</span><span class="n">Cos</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">Pi</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<span class="n">ya</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">Sin</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">Pi</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">W</span><span class="o">-</span><span class="n">R</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">xa</span><span class="p">,</span>   <span class="n">ya</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">W</span><span class="p">,</span>     <span class="n">R</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">W</span><span class="p">,</span>     <span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span>     <span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">W</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="n">Line</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">}</span> <span class="p">;</span>
<span class="n">Circle</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">};</span>
<span class="n">Circle</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">};</span>
<span class="n">Line</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span>
<span class="n">Line</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">};</span>
<span class="n">Line</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="n">Physical</span> <span class="n">Surface</span><span class="p">(</span><span class="s2">&quot;d_whole&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>
</pre></div>
</div>
</div>
<p>Having the file defined we can load it into GMSH to check if the geometry
is defined properly as illustrated in <a class="reference internal" href="#fig-nrq-gmsh-geo"><span class="std std-numref">Fig. 2</span></a>.</p>
<div class="figure" id="id5">
<span id="fig-nrq-gmsh-geo"></span><a class="reference internal image-reference" href="../../../images/notchedrectquarter_gmsh_geo.png"><img alt="../../../images/notchedrectquarter_gmsh_geo.png" src="../../../images/notchedrectquarter_gmsh_geo.png" style="width: 207.60000000000002px; height: 240.0px;" /></a>
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">GMSH visualisation of geometry defined in <a class="reference internal" href="#lst-notchedrectquarter"><span class="std std-numref">Listing 1</span></a>.</span></p>
</div>
<p>The last step is to run GMSH to generate mesh for the defined geometry
as illustrated in <a class="reference internal" href="#fig-nrq-gmsh-mesh"><span class="std std-numref">Fig. 3</span></a>.</p>
<div class="figure" id="id6">
<span id="fig-nrq-gmsh-mesh"></span><a class="reference internal image-reference" href="../../../images/notchedrectquarter_gmsh_mesh.png"><img alt="../../../images/notchedrectquarter_gmsh_mesh.png" src="../../../images/notchedrectquarter_gmsh_mesh.png" style="width: 259.5px; height: 300.0px;" /></a>
<p class="caption"><span class="caption-number">Fig. 3 </span><span class="caption-text">Mesh generated from the file shown in <a class="reference internal" href="#lst-notchedrectquarter"><span class="std std-numref">Listing 1</span></a>.</span></p>
</div>
</div>
<div class="section" id="creating-geometry-template-file">
<h2>Creating geometry template file<a class="headerlink" href="#creating-geometry-template-file" title="Permalink to this headline">¶</a></h2>
<p>Having GMSH input file properly defined we can not turn it into geometry
template file. We just need to copy the file into specific folder and change
its extension to :code`*.tpl`. In Nadamak all geometry template files are store
in folder <code class="docutils literal notranslate"><span class="pre">mesher/gmsh/geomodels</span></code>. For the subsequent steps we assume that
the code in <a class="reference internal" href="#lst-notchedrectquarter"><span class="std std-numref">Listing 1</span></a> is saved in file
<code class="docutils literal notranslate"><span class="pre">mesher/gmsh/geomodels/notchedrectquarter.tpl</span></code>.</p>
</div>
<div class="section" id="defining-matlab-class-for-geometric-model">
<h2>Defining Matlab class for geometric model<a class="headerlink" href="#defining-matlab-class-for-geometric-model" title="Permalink to this headline">¶</a></h2>
<p>To nicely handle geometric domain defined in <code class="docutils literal notranslate"><span class="pre">notchedrectquarter.lst</span></code> we need
to define a class derived from <code class="code docutils literal notranslate"><span class="pre">mp.GeomModel</span></code>. The base class
<code class="code docutils literal notranslate"><span class="pre">mp.GeomModel</span></code> provides functionality common to all geometric domains.
It also defines interface than each specific geometry class must obey to
smoothly integrate with the rest of Nadamak package. Here we assume that our
class will be called <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> <a class="footnote-reference" href="#f1" id="id1">[1]</a>. The definition of this class
shown in <a class="reference internal" href="#lst-notchedrqgeom-v1"><span class="std std-numref">Listing 2</span></a> is put in file
<code class="docutils literal notranslate"><span class="pre">package/+mp/+geoms/NotchedRQGeom.m</span></code> alongside other geometric domain
classes.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<span id="lst-notchedrqgeom-v1"></span><div class="code-block-caption"><span class="caption-number">Listing 2 </span><span class="caption-text">Definition of class <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code></span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="k">classdef</span> <span class="n">NotchedRQGeom</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="p">.</span><span class="n">GeomModel</span> 
</span>  <span class="c">% Geometric model for a quarter of notched rectangle.</span>
   <span class="k">properties</span> <span class="p">(</span><span class="n">Access</span><span class="p">=</span><span class="n">public</span><span class="p">)</span>
    <span class="n">params</span> <span class="p">=</span> <span class="n">struct</span><span class="p">();</span>
  <span class="k">end</span>
  <span class="k">methods</span><span class="p">(</span><span class="n">Access</span><span class="p">=</span><span class="n">private</span><span class="p">)</span>
<span class="hll"><span class="k">    function</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span>obj, params_<span class="p">)</span><span class="w"></span>
</span><span class="w">    </span><span class="k">end</span>
  <span class="k">end</span>
  <span class="k">methods</span>
<span class="hll"><span class="k">    function</span><span class="w"> </span>[obj] <span class="p">=</span><span class="w"> </span><span class="nf">NotchedRQGeom</span><span class="p">(</span>name, params, legacyID<span class="p">)</span><span class="w"></span>
</span><span class="w">      </span><span class="k">if</span> <span class="n">nargin</span> <span class="o">&lt;</span> <span class="mi">3</span>
        <span class="n">legacyID</span> <span class="p">=</span> <span class="mi">810</span><span class="p">;</span>
      <span class="k">end</span>
      <span class="k">if</span> <span class="n">nargin</span> <span class="o">&lt;</span> <span class="mi">2</span>
        <span class="n">params</span> <span class="p">=</span> <span class="n">struct</span><span class="p">();</span>
      <span class="k">end</span>
      <span class="n">obj</span> <span class="p">=</span> <span class="n">obj</span><span class="p">@</span><span class="n">mp</span><span class="p">.</span><span class="n">GeomModel</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">legacyID</span><span class="p">);</span>
      <span class="k">if</span> <span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">obj</span><span class="p">.</span><span class="n">setup</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
      <span class="k">end</span>
    <span class="k">end</span>
<span class="hll"><span class="k">    function</span><span class="w"> </span>[regionNames] <span class="p">=</span><span class="w"> </span><span class="nf">regions</span><span class="p">(</span>obj<span class="p">)</span><span class="w"></span>
</span><span class="w">      </span><span class="n">regionNames</span> <span class="p">=</span> <span class="p">{</span><span class="s">&#39;d_whole&#39;</span><span class="p">};</span>
    <span class="k">end</span>
<span class="hll"><span class="k">    function</span><span class="w"> </span>[name] <span class="p">=</span><span class="w"> </span><span class="nf">templateName</span><span class="p">(</span>obj<span class="p">)</span><span class="w"></span>
</span><span class="w">      </span><span class="n">name</span> <span class="p">=</span> <span class="s">&#39;notchedrectquarter.tpl&#39;</span><span class="p">;</span>
    <span class="k">end</span>
<span class="hll"><span class="k">    function</span><span class="w"> </span>[maxlc] <span class="p">=</span><span class="w"> </span><span class="nf">coarsest_lc</span><span class="p">(</span>obj<span class="p">)</span><span class="w"></span>
</span><span class="w">      </span><span class="n">maxlc</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Lines 11-22 define <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> constructor. The constructors for
geometric domain classes look virtually the same. The real work to construct an
object is delegated to <code class="code docutils literal notranslate"><span class="pre">setup</span></code> method defined at lines 7-8. For a moment
<code class="code docutils literal notranslate"><span class="pre">setup</span></code> method is empty, but later we extend it when adding more
functionality to our class. The <code class="code docutils literal notranslate"><span class="pre">legacyID</span></code> variable define in line 13 is
the reminiscence of the old design in which each distinct geometric model had
unique numeric ID. The value assigned to <code class="code docutils literal notranslate"><span class="pre">legacyID</span></code> is arbitrary with one
condition that it should be greater than 100.</p>
<p>Attention should be paid to line 18. At this line the constructor of base class
is called. The second argument of <code class="code docutils literal notranslate"><span class="pre">mp.GeomModel</span></code> constructor is the
geometric dimension of the model. All geometric models are embedded in
3-dimensional real space, but themselves they can be 1D, 2D or 3D objects.</p>
<p>As our <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> class is derived from <code class="code docutils literal notranslate"><span class="pre">mp.GeomModel</span></code>
abstract base class it has to define the following three methods</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">regions(obj)</span></code> - method that return names of physical regions as a cell
array of strings.</li>
<li><code class="code docutils literal notranslate"><span class="pre">templateName(obj)</span></code> - method that returns the name
of geometry template file.</li>
<li><code class="code docutils literal notranslate"><span class="pre">coarsest_lc(obj)</span></code> - method that return the real value used as mesh
density parameter. Nadamak provides some convenience functions to visualize
geometric domains but this can be done only via meshes generated on them. The
mesh density parameter returned by <code class="code docutils literal notranslate"><span class="pre">coarsest_lc</span></code> method is just an
educated guess about mesh density that will still capture geometric features
of the domain but the same time will have the smallest number of elements to
not induce unnecessary overhead.</li>
</ul>
<p>Having <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> class defined we can use it in the meshing
framework. The example shown in <a class="reference internal" href="#lst-notched-use-v1"><span class="std std-numref">Listing 3</span></a> produces mesh
shown in <a class="reference internal" href="#fig-notched-mesh-v1"><span class="std std-numref">Fig. 4</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<span id="lst-notched-use-v1"></span><div class="code-block-caption"><span class="caption-number">Listing 3 </span><span class="caption-text">Example of using <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> class.</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">mesher</span> <span class="p">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">Mesher</span><span class="p">();</span>

<span class="n">geom</span> <span class="p">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">geoms</span><span class="p">.</span><span class="n">NotchedRQGeom</span><span class="p">(</span><span class="s">&#39;my_domain&#39;</span><span class="p">);</span>

<span class="n">mesh</span> <span class="p">=</span> <span class="n">mesher</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">struct</span><span class="p">(</span><span class="s">&#39;lc&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">));</span>

<span class="n">viewer</span> <span class="p">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">Viewer</span><span class="p">();</span>
<span class="n">viewer</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">mesh</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="figure" id="id9">
<span id="fig-notched-mesh-v1"></span><img alt="../../../images/NotchedRQGeom_mesh_v1.png" src="../../../images/NotchedRQGeom_mesh_v1.png" />
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">Mesh generated and visualized in <a class="reference internal" href="#lst-notched-use-v1"><span class="std std-numref">Listing 3</span></a>.</span></p>
</div>
</div>
<div class="section" id="extending-notchedrqgeom-class">
<h2>Extending <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> class<a class="headerlink" href="#extending-notchedrqgeom-class" title="Permalink to this headline">¶</a></h2>
<p>At this moment we can notice that the class <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> is sort of
a <em>dumb</em> one. We can use it to generated mesh in the specific geometry, but we
have no means of controlling the model dimensions nor meshing parameters.  This
is related to the fact that the geometry template file
<code class="docutils literal notranslate"><span class="pre">notchedrectquarter.lst</span></code> is all the time the same, thus GMSH produces all the
time the same mesh.</p>
<p>The first step in adding features to <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> is to turn
<code class="docutils literal notranslate"><span class="pre">notchedrectquarter.lst</span></code> into true template file as shown in
<a class="reference internal" href="#lst-notched-template-v1"><span class="std std-numref">Listing 4</span></a>.  In highlighted lines instead of specific
values we put named placeholders obeying the syntax <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> <em>name</em> <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>. The
placeholder name can be arbitrary as long as it is a valid Matlab identifier
<a class="footnote-reference" href="#f2" id="id2">[2]</a>.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<span id="lst-notched-template-v1"></span><div class="code-block-caption"><span class="caption-number">Listing 4 </span><span class="caption-text">GMSH input file turned into template.</span><a class="headerlink" href="#id10" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="n">lc</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">lc</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class="hll"><span class="n">R</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">dR</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class="hll"><span class="n">W</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">dW</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class="hll"><span class="n">H</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">dH</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class="hll"><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">amid</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class="n">xa</span> <span class="o">=</span> <span class="n">W</span><span class="o">-</span><span class="n">R</span><span class="o">*</span><span class="n">Cos</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">Pi</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<span class="n">ya</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">Sin</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">Pi</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">W</span><span class="o">-</span><span class="n">R</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">xa</span><span class="p">,</span>   <span class="n">ya</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">W</span><span class="p">,</span>     <span class="n">R</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">W</span><span class="p">,</span>     <span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span>     <span class="n">H</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lc</span><span class="p">};</span>
<span class="n">Point</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">W</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="n">Line</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">}</span> <span class="p">;</span>
<span class="n">Circle</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">};</span>
<span class="n">Circle</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">};</span>
<span class="n">Line</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span>
<span class="n">Line</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">};</span>
<span class="n">Line</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">};</span>
<span class="n">Line</span> <span class="n">Loop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">};</span>
<span class="n">Plane</span> <span class="n">Surface</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>
<span class="n">Physical</span> <span class="n">Surface</span><span class="p">(</span><span class="s2">&quot;d_whole&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">};</span>
</pre></div>
</div>
</div>
<p>The second step is to modify definition of <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> class by
defining parameters corresponding to placeholders in geometry template file and
respectively fixing <code class="code docutils literal notranslate"><span class="pre">setup</span></code> method to properly initialize the parameters
either form constructor arguments or from default values. New version of
<code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> class is shown in <a class="reference internal" href="#lst-notchedrqgeom-v2"><span class="std std-numref">Listing 5</span></a> with new
lines highlighted.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<span id="lst-notchedrqgeom-v2"></span><div class="code-block-caption"><span class="caption-number">Listing 5 </span><span class="caption-text">Fragment of modified definition of class <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> with changes highlighted.</span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">classdef</span> <span class="n">NotchedRQGeom</span> <span class="o">&lt;</span> <span class="n">mp</span><span class="p">.</span><span class="n">GeomModel</span> 
  <span class="c">% Geometric model for a quarter of notched rectangle.</span>
  <span class="k">properties</span> <span class="p">(</span><span class="n">Access</span><span class="p">=</span><span class="n">public</span><span class="p">)</span>
<span class="hll">    <span class="n">params</span> <span class="p">=</span> <span class="n">struct</span><span class="p">(</span><span class="s">&#39;dW&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;dH&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;dR&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;amid&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
</span>  <span class="k">end</span>
  <span class="k">methods</span><span class="p">(</span><span class="n">Access</span><span class="p">=</span><span class="n">private</span><span class="p">)</span>
<span class="k">    function</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span>obj, params_<span class="p">)</span><span class="w"></span>
<span class="hll"><span class="w">      </span><span class="n">obj</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dW</span> <span class="p">=</span> <span class="n">mp_get_option</span><span class="p">(</span><span class="n">params_</span><span class="p">,</span> <span class="s">&#39;dW&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dW</span><span class="p">);</span>
</span><span class="hll">      <span class="n">obj</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dH</span> <span class="p">=</span> <span class="n">mp_get_option</span><span class="p">(</span><span class="n">params_</span><span class="p">,</span> <span class="s">&#39;dH&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dH</span><span class="p">);</span>
</span><span class="hll">      <span class="n">obj</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dR</span> <span class="p">=</span> <span class="n">mp_get_option</span><span class="p">(</span><span class="n">params_</span><span class="p">,</span> <span class="s">&#39;dR&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dR</span><span class="p">);</span>
</span><span class="hll">      <span class="n">obj</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">amid</span> <span class="p">=</span> <span class="n">mp_get_option</span><span class="p">(</span><span class="n">params_</span><span class="p">,</span> <span class="s">&#39;amid&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">amid</span><span class="p">);</span>
</span>    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<p>With geometry template file and the class augmented in the above way it is now
possible to control both geometry and mesh density as shown in <a class="reference internal" href="#lst-notched-use-v2"><span class="std std-numref">Listing 6</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<span id="lst-notched-use-v2"></span><div class="code-block-caption"><span class="caption-number">Listing 6 </span><span class="caption-text">Controling geometry and mesh densit with extended <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> class.</span><a class="headerlink" href="#id12" title="Permalink to this code">¶</a></div>
<div class="highlight-matlab notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">mesher</span> <span class="p">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">Mesher</span><span class="p">();</span>

<span class="n">geom</span> <span class="p">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">geoms</span><span class="p">.</span><span class="n">NotchedRQGeom</span><span class="p">(</span><span class="s">&#39;my_domain&#39;</span><span class="p">);</span>
<span class="n">geom</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dR</span> <span class="p">=</span> <span class="mf">0.5</span><span class="p">;</span>
<span class="n">geom</span><span class="p">.</span><span class="n">params</span><span class="p">.</span><span class="n">dH</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">mesh</span> <span class="p">=</span> <span class="n">mesher</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">struct</span><span class="p">(</span><span class="s">&#39;lc&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">));</span>

<span class="n">viewer</span> <span class="p">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">Viewer</span><span class="p">();</span>
<span class="n">viewer</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">mesh</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="figure" id="id13">
<span id="fig-notched-mesh-v2"></span><img alt="../../../images/NotchedRQGeom_mesh_v2.png" src="../../../images/NotchedRQGeom_mesh_v2.png" />
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">Mesh generated and visualized in <a class="reference internal" href="#lst-notched-use-v2"><span class="std std-numref">Listing 6</span></a>.</span></p>
</div>
<p>The exercise of extending the class <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> clearly shows how
simple is the mechanism for passing data from Matlab level to GMSH.  This
mechanism is based on textual substitution of placeholders in a template file
by values of corresponding Matlab variables. The substitution values come
either from geometric model object, for instance model dimensions,  or form
mesher object, for instance mesh density parameters. The values passed passed
from Matlab to GMSH, can be either scalars or vectors. In case of vector valued
parameters the substitution string is formed by values of vector elements
separated by comas without any other syntactic characters. Thus to properly
handle such substitutions on GMSH side, one has to make sure that proper GMSH
syntax for list literals is used. This is illustrated in
<a class="reference internal" href="#lst-gmsh-lists-placeholder"><span class="std std-numref">Listing 7</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id14">
<span id="lst-gmsh-lists-placeholder"></span><div class="code-block-caption"><span class="caption-number">Listing 7 </span><span class="caption-text">Handling substitution of vector valued variables.</span><a class="headerlink" href="#id14" title="Permalink to this code">¶</a></div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vecparam = {&lt;vecparam&gt;};
</pre></div>
</div>
</div>
<p>Similar rule applies to the case of string valued parameters.
Further extensions to a geometric model class and template file are case specific and will strongly dependon functionality provided by GMSH scripting language. Below we discuss some extensions that are likely to be relevant to many geometric domains. They are:</p>
<ul class="simple">
<li>subdivision of domain into subdomains,</li>
<li>selection of the type of generated elements,</li>
<li>management of mesh density by local refinements,</li>
<li>handling boundary regions,</li>
<li>independent meshing of regions and their combinations.</li>
</ul>
<div class="section" id="subdivision-of-meshing-domain-into-subdomains">
<h3>Subdivision of meshing domain into subdomains<a class="headerlink" href="#subdivision-of-meshing-domain-into-subdomains" title="Permalink to this headline">¶</a></h3>
<div class="figure" id="id15">
<span id="fig-notched-mesh-v3"></span><img alt="../../../images/NotchedRQGeom_mesh_v3.png" src="../../../images/NotchedRQGeom_mesh_v3.png" />
<p class="caption"><span class="caption-number">Fig. 6 </span><span class="caption-text">Meshing domain subdivided into subdomain.</span></p>
</div>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>While not strictly necessary the naming convention addopted in Nadamak is such that names of classes for geometric models have the <code class="docutils literal notranslate"><span class="pre">Geom</span></code> suffix.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>While not strictly necessary the naming convention addopted in Nadamak is such that names of placeholders corresponding to dimension parameters have <code class="docutils literal notranslate"><span class="pre">d</span></code> prefix, for instance <code class="docutils literal notranslate"><span class="pre">dL</span></code>, <code class="docutils literal notranslate"><span class="pre">dH</span></code>, etc.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Adding new meshing domains</a><ul>
<li><a class="reference internal" href="#creating-gmsh-geometry-input-file">Creating GMSH geometry input file</a></li>
<li><a class="reference internal" href="#creating-geometry-template-file">Creating geometry template file</a></li>
<li><a class="reference internal" href="#defining-matlab-class-for-geometric-model">Defining Matlab class for geometric model</a></li>
<li><a class="reference internal" href="#extending-notchedrqgeom-class">Extending <code class="code docutils literal notranslate"><span class="pre">NotchedRQGeom</span></code> class</a><ul>
<li><a class="reference internal" href="#subdivision-of-meshing-domain-into-subdomains">Subdivision of meshing domain into subdomains</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../development.html"
                        title="previous chapter">Extending Nadamak</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../sources/src/development/geodomains/addnewdomain.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../mat-modindex.html" title="MATLAB Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../development.html" title="Extending Nadamak"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Nadamak 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../development.html" >Extending Nadamak</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Roman Putanowicz.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.
    </div>
  </body>
</html>